(()=>{var a={};a.id=314,a.ids=[314],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:a=>{"use strict";a.exports=require("querystring")},12412:a=>{"use strict";a.exports=require("assert")},12912:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>H,patchFetch:()=>G,routeModule:()=>C,serverHooks:()=>F,workAsyncStorage:()=>D,workUnitAsyncStorage:()=>E});var d={};c.r(d),c.d(d,{PUT:()=>A});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(52963),w=c(67360),x=c(72987),y=c(52731),z=c(31670);async function A(a,{params:b}){try{if(!await (0,v.getServerSession)(w.N))return u.NextResponse.json({error:"Unauthorized"},{status:401});let{id:c}=await b,{status:d,sendEmail:e}=await a.json();if(!d)return u.NextResponse.json({error:"Status is required"},{status:400});if(!["ORDER_RECEIVED","PAID_PENDING_SHIPMENT","PAID","CANCELLED","RECEIVED","QUOTE_SENT","REPAIRING","SHIPPED_AND_COMPLETE"].includes(d))return u.NextResponse.json({error:"Invalid status"},{status:400});let f=await x.z.order.update({where:{id:c},data:{status:d},include:{items:{include:{product:{select:{id:!0,name:!0}}}},serialNumbers:{include:{product:{select:{id:!0,name:!0}}}}}});if(e&&f.customerEmail)try{await B(f,d)}catch(a){console.error("Failed to send status update email:",a)}return u.NextResponse.json(f)}catch(a){return console.error("Error updating order status:",a),u.NextResponse.json({error:"Failed to update order status"},{status:500})}}async function B(a,b){let c=y.createTransport({host:process.env.SMTP_HOST,port:parseInt(process.env.SMTP_PORT||"587"),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}}),d=a.items?.some(a=>"mail-in-service"===a.product.id)||!1,e=z.i.formatStatusUpdateEmail(a,d,b),f={from:process.env.SMTP_FROM||"noreply@jbinverters.com",to:a.customerEmail,subject:e.subject,html:e.html};await c.sendMail(f)}let C=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/admin/orders/[id]/status/route",pathname:"/api/admin/orders/[id]/status",filename:"route",bundlePath:"app/api/admin/orders/[id]/status/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/var/www/jbinverters/src/app/api/admin/orders/[id]/status/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:D,workUnitAsyncStorage:E,serverHooks:F}=C;function G(){return(0,g.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:E})}async function H(a,b,c){var d;let e="/api/admin/orders/[id]/status/route";"/index"===e&&(e="/");let g=await C.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(y.dynamicRoutes[E]||y.routes[D]);if(F&&!x){let a=!!y.routes[D],b=y.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||C.isDev||x||(G="/index"===(G=D)?"/":G);let H=!0===C.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>C.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>C.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await C.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await C.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await C.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},14985:a=>{"use strict";a.exports=require("dns")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},21820:a=>{"use strict";a.exports=require("os")},27910:a=>{"use strict";a.exports=require("stream")},28354:a=>{"use strict";a.exports=require("util")},29021:a=>{"use strict";a.exports=require("fs")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31670:(a,b,c)=>{"use strict";c.d(b,{i:()=>j});var d=c(29021),e=c.n(d),f=c(33873),g=c.n(f),h=c(96505);class i{constructor(){this.templates=new Map,this.configPath=g().join(process.cwd(),"config","email-templates")}static getInstance(){return i.instance||(i.instance=new i),i.instance}loadTemplate(a){try{let b=g().join(this.configPath,a),c=e().readFileSync(b,"utf-8");return JSON.parse(c)}catch(b){throw console.error(`Failed to load email template ${a}:`,b),Error(`Email template ${a} not found or invalid`)}}getTemplate(a){if(!this.templates.has(a)){let b=this.loadTemplate("product"===a?"product-orders.json":"repair-orders.json");this.templates.set(a,b)}return this.templates.get(a)}reloadTemplates(){this.templates.clear(),console.log("Email templates cache cleared - templates will be reloaded from disk")}getInitialConfirmationTemplate(a){return this.getTemplate(a?"repair":"product").initialConfirmation}getStatusUpdateTemplate(a,b){let c=a?"repair":"product",d=this.getTemplate(c).statusUpdates[b];if(!d)throw Error(`Status template not found for ${c} orders: ${b}`);return d}getHtmlTemplate(a){return this.getTemplate(a?"repair":"product").htmlTemplate.wrapper}formatInitialConfirmationEmail(a,b){let c=this.formatStatusUpdateEmail(a,b,"ORDER_RECEIVED"),d=this.getInitialConfirmationTemplate(b);return{subject:c.subject,html:c.html,fromEmail:d.fromEmail}}formatStatusUpdateEmail(a,b,c){let d=this.getStatusUpdateTemplate(b,c),e=new Date(a.createdAt).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}),f=a.items.map(a=>`- ${a.product.name} (Qty: ${a.quantity}) - $${a.price.toFixed(2)}`).join("\n"),g=d.message;"QUOTE_SENT"===c&&a.repairQuote&&(g=d.messageWithQuote||d.message);let i=g.replace(/\[customerName\]/g,(0,h.ZD)(a.customerName||"Valued Customer")).replace(/\[orderDate\]/g,(0,h.ZD)(e)).replace(/\[customerAddress\]/g,(0,h.ZD)(a.customerAddress||"No address provided")).replace(/\[orderNumber\]/g,(0,h.ZD)(a.orderNumber)).replace(/\[itemsList\]/g,(0,h.ZD)(f)).replace(/\[total\]/g,a.total.toFixed(2)).replace(/\[trackingNumber\]/g,(0,h.ZD)(a.trackingNumber||"Not yet assigned")).replace(/\[repairQuote\]/g,(0,h.ZD)(a.repairQuote||"No quote available"));return{subject:d.subject.replace(/\[customerName\]/g,a.customerName||"Valued Customer").replace(/\[orderDate\]/g,e).replace(/\[customerAddress\]/g,a.customerAddress||"No address provided").replace(/\[orderNumber\]/g,a.orderNumber).replace(/\[total\]/g,a.total.toFixed(2)).replace(/\[trackingNumber\]/g,a.trackingNumber||"Not yet assigned"),html:`
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <div style="white-space: pre-line;">${i}</div>
        
      </div>
    `}}}let j=i.getInstance()},33873:a=>{"use strict";a.exports=require("path")},34631:a=>{"use strict";a.exports=require("tls")},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{"use strict";a.exports=require("crypto")},55591:a=>{"use strict";a.exports=require("https")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},67360:(a,b,c)=>{"use strict";c.d(b,{N:()=>g});var d=c(28120),e=c(7028),f=c(72987);let g={providers:[(0,d.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a){if(!a?.email||!a?.password)return null;if((await f.z.loginAttempt.findMany({where:{email:a.email,createdAt:{gte:new Date(Date.now()-9e5)}}})).length>=5)return console.log("Too many login attempts for:",a.email),null;let b=await f.z.admin.findUnique({where:{email:a.email}});return b&&await e.Ay.compare(a.password,b.password)?(await f.z.loginAttempt.create({data:{email:a.email,success:!0,ipAddress:"unknown"}}),{id:b.id,email:b.email}):(await f.z.loginAttempt.create({data:{email:a.email,success:!1,ipAddress:"unknown"}}),null)}})],session:{strategy:"jwt",maxAge:28800,updateAge:3600},jwt:{maxAge:28800},cookies:{sessionToken:{name:"next-auth.session-token",options:{httpOnly:!0,sameSite:"strict",path:"/",secure:!0,domain:".jbinverters.com"}},callbackUrl:{name:"next-auth.callback-url",options:{httpOnly:!0,sameSite:"strict",path:"/",secure:!0,domain:".jbinverters.com"}},csrfToken:{name:"next-auth.csrf-token",options:{httpOnly:!0,sameSite:"strict",path:"/",secure:!0,domain:".jbinverters.com"}}},pages:{signIn:"/admin/login",error:"/admin/login?error=SessionError"},callbacks:{jwt:async({token:a,user:b,account:c})=>(b&&(a.id=b.id,a.iat=Math.floor(Date.now()/1e3)),Date.now()<1e3*a.exp-36e5)?a:{...a,exp:Math.floor(Date.now()/1e3)+28800},session:async({session:a,token:b})=>(b&&a.user&&(a.user.id=b.id),a),redirect:async({url:a,baseUrl:b})=>a.startsWith("/")?`${b}${a}`:new URL(a).origin===b?a:b},events:{async signOut({token:a}){console.log("User signed out:",a?.email)}},debug:!1}},72987:(a,b,c)=>{"use strict";c.d(b,{z:()=>e});let d=require("@prisma/client"),e=globalThis.prisma??new d.PrismaClient},74075:a=>{"use strict";a.exports=require("zlib")},78335:()=>{},79428:a=>{"use strict";a.exports=require("buffer")},79551:a=>{"use strict";a.exports=require("url")},79646:a=>{"use strict";a.exports=require("child_process")},81630:a=>{"use strict";a.exports=require("http")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},91645:a=>{"use strict";a.exports=require("net")},94735:a=>{"use strict";a.exports=require("events")},96487:()=>{},96505:(a,b,c)=>{"use strict";c.d(b,{BM:()=>f,HU:()=>g,Ko:()=>i,ZD:()=>e,bG:()=>j});var d=c(59507);function e(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/\//g,"&#x2F;")}let f=d.Ikc({name:d.YjP().min(1,"Name is required").max(100,"Name must be less than 100 characters").regex(/^[a-zA-Z\s\-'\.]+$/,"Name contains invalid characters").refine(a=>!/<script|javascript:|vbscript:/i.test(a),"Name contains potentially malicious content"),email:d.YjP().min(1,"Email is required").email("Invalid email format").max(255,"Email must be less than 255 characters").refine(a=>!/<script|javascript:|vbscript:/i.test(a),"Email contains potentially malicious content"),message:d.YjP().min(1,"Message is required").max(2e3,"Message must be less than 2000 characters").refine(a=>!/<script|javascript:|vbscript:|onload=|onerror=/i.test(a),"Message contains potentially malicious content")}),g=d.Ikc({name:d.YjP().min(1,"Product name is required").max(255,"Product name must be less than 255 characters").refine(a=>!/<script|javascript:|vbscript:/i.test(a),"Product name contains potentially malicious content"),description:d.YjP().max(1e3,"Description must be less than 1000 characters").refine(a=>!a||!/<script|javascript:|vbscript:/i.test(a),"Description contains potentially malicious content").optional(),price:d.aig().positive("Price must be positive").max(999999.99,"Price too high").refine(a=>!isNaN(a)&&isFinite(a),"Price must be a valid number"),imageUrl:d.YjP().max(500,"Image URL too long").optional().refine(a=>{if(!a)return!0;let b=a.startsWith("/")||a.startsWith("http://")||a.startsWith("https://"),c=!/<script|javascript:|vbscript:/i.test(a);return b&&c},"Image URL must be a valid path or URL without malicious content"),stock:d.aig().int("Stock must be an integer").min(0,"Stock cannot be negative").max(99999,"Stock too high").refine(a=>!isNaN(a)&&isFinite(a),"Stock must be a valid number"),displayOrder:d.aig().int("Display order must be an integer").min(0,"Display order cannot be negative").max(9999,"Display order too high").refine(a=>!isNaN(a)&&isFinite(a),"Display order must be a valid number").default(0),isActive:d.zMY().default(!0)}),h=d.Ikc({id:d.YjP().min(1,"Product ID is required"),quantity:d.aig().int("Quantity must be an integer").min(1,"Quantity must be at least 1").max(999,"Quantity too high"),price:d.aig().positive("Price must be positive").max(999999.99,"Price too high")}),i=d.Ikc({customerName:d.YjP().max(255,"Customer name too long").optional(),customerEmail:d.YjP().email("Invalid email format").max(255,"Email too long").optional(),customerAddress:d.YjP().max(1e3,"Address too long").optional(),customerPhone:d.YjP().max(50,"Phone number too long").optional(),items:d.YOg(h).min(1,"At least one item is required").max(50,"Too many items"),total:d.aig().positive("Total must be positive").max(999999.99,"Total too high")});function j(a,b){try{let c=function a(b){if(null==b)return b;if("string"==typeof b){let a=b.replace(/\0/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"").trim();for(let b of[/<script[^>]*>.*?<\/script>/gi,/javascript:/gi,/vbscript:/gi,/onload=/gi,/onerror=/gi,/onclick=/gi,/onmouseover=/gi,/data:text\/html/gi,/expression\s*\(/gi])if(b.test(a))throw Error("Potentially malicious input detected");return a}if(Array.isArray(b))return b.map(a);if("object"==typeof b&&null!==b){let c={};for(let[d,e]of Object.entries(b)){if(!/^[a-zA-Z0-9_-]+$/.test(d))throw Error("Invalid object key detected");c[d]=a(e)}return c}return b}(b),d=a.parse(c);return{success:!0,data:d}}catch(a){if(a instanceof d.GaX)return{success:!1,errors:(a.issues||[]).map(a=>`${a.path.join(".")}: ${a.message}`)};if(a instanceof Error&&a.message.includes("malicious"))return{success:!1,errors:["Potentially malicious input detected"]};return console.error("Validation error:",a),{success:!1,errors:["Invalid input format"]}}}d.Ikc({serialNumbers:d.YOg(d.YjP()).min(1,"Serial numbers are required").max(100,"Too many serial numbers"),notes:d.YjP().max(500,"Notes too long").optional()})}};var b=require("../../../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[996,692,577,507,112],()=>b(b.s=12912));module.exports=c})();